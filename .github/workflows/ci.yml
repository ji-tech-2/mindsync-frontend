name: CI

on:
  pull_request:
    branches:
      - main

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run linter
        run: npm run lint
        continue-on-error: true

      - name: Generate complexity report
        run: npm run quality:complexity
        continue-on-error: true

      - name: Run tests with coverage
        run: npm run test:coverage:threshold
        continue-on-error: true

      - name: Parse coverage summary
        id: coverage
        run: |
          if [ -f coverage/coverage-summary.json ]; then
            LINES=$(jq '.total.lines.pct' coverage/coverage-summary.json)
            STATEMENTS=$(jq '.total.statements.pct' coverage/coverage-summary.json)
            FUNCTIONS=$(jq '.total.functions.pct' coverage/coverage-summary.json)
            BRANCHES=$(jq '.total.branches.pct' coverage/coverage-summary.json)
            echo "lines=$LINES" >> $GITHUB_OUTPUT
            echo "statements=$STATEMENTS" >> $GITHUB_OUTPUT
            echo "functions=$FUNCTIONS" >> $GITHUB_OUTPUT
            echo "branches=$BRANCHES" >> $GITHUB_OUTPUT
          else
            echo "lines=0" >> $GITHUB_OUTPUT
            echo "statements=0" >> $GITHUB_OUTPUT
            echo "functions=0" >> $GITHUB_OUTPUT
            echo "branches=0" >> $GITHUB_OUTPUT
          fi

      - name: Parse complexity metrics
        id: complexity
        run: |
          if [ -f complexity-report.json ]; then
            COMPLEXITY_RULES='complexity|max-depth|max-lines-per-function|max-nested-callbacks|max-params'
            TOTAL_WARNINGS=$(jq "[.[] | .messages[] | select(.ruleId | test(\"$COMPLEXITY_RULES\")) | select(.severity == 1)] | length" complexity-report.json 2>/dev/null || echo "0")
            TOTAL_ERRORS=$(jq "[.[] | .messages[] | select(.ruleId | test(\"$COMPLEXITY_RULES\")) | select(.severity == 2)] | length" complexity-report.json 2>/dev/null || echo "0")
            echo "warnings=$TOTAL_WARNINGS" >> $GITHUB_OUTPUT
            echo "errors=$TOTAL_ERRORS" >> $GITHUB_OUTPUT
          else
            echo "warnings=0" >> $GITHUB_OUTPUT
            echo "errors=0" >> $GITHUB_OUTPUT
          fi

      - name: Generate workflow summary
        run: |
          echo "# üìä Code Quality & Coverage Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## üéØ Coverage Metrics" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Coverage | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|----------|--------|" >> $GITHUB_STEP_SUMMARY

          LINES="${{ steps.coverage.outputs.lines }}"
          STATEMENTS="${{ steps.coverage.outputs.statements }}"
          FUNCTIONS="${{ steps.coverage.outputs.functions }}"
          BRANCHES="${{ steps.coverage.outputs.branches }}"

          # Lines
          if (( $(echo "$LINES >= 80" | bc -l 2>/dev/null || echo "0") )); then
            echo "| Lines | ${LINES}% | ‚úÖ Pass |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Lines | ${LINES}% | ‚ùå Fail (< 80%) |" >> $GITHUB_STEP_SUMMARY
          fi

          # Statements
          if (( $(echo "$STATEMENTS >= 80" | bc -l 2>/dev/null || echo "0") )); then
            echo "| Statements | ${STATEMENTS}% | ‚úÖ Pass |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Statements | ${STATEMENTS}% | ‚ùå Fail (< 80%) |" >> $GITHUB_STEP_SUMMARY
          fi

          # Functions
          if (( $(echo "$FUNCTIONS >= 80" | bc -l 2>/dev/null || echo "0") )); then
            echo "| Functions | ${FUNCTIONS}% | ‚úÖ Pass |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Functions | ${FUNCTIONS}% | ‚ùå Fail (< 80%) |" >> $GITHUB_STEP_SUMMARY
          fi

          # Branches
          if (( $(echo "$BRANCHES >= 75" | bc -l 2>/dev/null || echo "0") )); then
            echo "| Branches | ${BRANCHES}% | ‚úÖ Pass |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Branches | ${BRANCHES}% | ‚ùå Fail (< 75%) |" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## üîç Code Quality Metrics" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Count | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|--------|" >> $GITHUB_STEP_SUMMARY

          WARNINGS="${{ steps.complexity.outputs.warnings }}"
          ERRORS="${{ steps.complexity.outputs.errors }}"

          if [ "$ERRORS" = "0" ]; then
            echo "| ESLint Errors | $ERRORS | ‚úÖ Pass |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| ESLint Errors | $ERRORS | ‚ùå Fail |" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "$WARNINGS" -le "10" ]; then
            echo "| ESLint Warnings | $WARNINGS | ‚úÖ Pass (‚â§ 10) |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| ESLint Warnings | $WARNINGS | ‚ö†Ô∏è Warning (> 10) |" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## üìù Quality Thresholds" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Coverage**: Lines ‚â• 80%, Statements ‚â• 80%, Functions ‚â• 80%, Branches ‚â• 75%" >> $GITHUB_STEP_SUMMARY
          echo "- **Complexity**: Max cyclomatic complexity = 15" >> $GITHUB_STEP_SUMMARY
          echo "- **Function Length**: Max 50 lines per function" >> $GITHUB_STEP_SUMMARY
          echo "- **Nesting**: Max depth = 4, Max nested callbacks = 3" >> $GITHUB_STEP_SUMMARY

      - name: Upload coverage reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-report
          path: coverage/
          retention-days: 30

      - name: Upload complexity report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: complexity-report
          path: complexity-report.json
          retention-days: 30

      - name: Check quality gates
        run: |
          LINES="${{ steps.coverage.outputs.lines }}"
          STATEMENTS="${{ steps.coverage.outputs.statements }}"
          FUNCTIONS="${{ steps.coverage.outputs.functions }}"
          BRANCHES="${{ steps.coverage.outputs.branches }}"
          ERRORS="${{ steps.complexity.outputs.errors }}"

          FAIL=false

          if (( $(echo "$LINES < 80" | bc -l 2>/dev/null || echo "1") )); then
            echo "‚ùå Lines coverage below threshold: ${LINES}% < 80%"
            FAIL=true
          fi

          if (( $(echo "$STATEMENTS < 80" | bc -l 2>/dev/null || echo "1") )); then
            echo "‚ùå Statements coverage below threshold: ${STATEMENTS}% < 80%"
            FAIL=true
          fi

          if (( $(echo "$FUNCTIONS < 80" | bc -l 2>/dev/null || echo "1") )); then
            echo "‚ùå Functions coverage below threshold: ${FUNCTIONS}% < 80%"
            FAIL=true
          fi

          if (( $(echo "$BRANCHES < 75" | bc -l 2>/dev/null || echo "1") )); then
            echo "‚ùå Branches coverage below threshold: ${BRANCHES}% < 75%"
            FAIL=true
          fi

          if [ "$ERRORS" != "0" ]; then
            echo "‚ùå ESLint errors found: $ERRORS"
            FAIL=true
          fi

          if [ "$FAIL" = true ]; then
            echo "Quality gates failed!"
            exit 1
          else
            echo "‚úÖ All quality gates passed!"
          fi
